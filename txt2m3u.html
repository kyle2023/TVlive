<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>TXT ⇄ M3U 转换工具</title>
<style>
body{font-family:"Microsoft YaHei",sans-serif;background:#f5f7fa;padding:40px;color:#333;}
h1{text-align:center;margin-bottom:20px;font-size:26px;color:#222;}
.container{max-width:950px;margin:auto;background:#fff;padding:25px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.15);}
textarea{width:100%;height:250px;margin-bottom:20px;border-radius:8px;border:1px solid #ccc;padding:12px;font-size:14px;line-height:1.6;resize:vertical;}
input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-bottom:20px;font-size:14px;}
button{background:#409eff;color:#fff;border:none;padding:10px 20px;margin:0 10px;border-radius:6px;font-size:15px;cursor:pointer;transition:.3s;}
button:hover{background:#66b1ff;}
#button-group{text-align:center;margin-bottom:20px;}
label{display:block;margin-bottom:6px;font-weight:bold;}
</style>
</head>
<body>
<h1>TXT ⇄ M3U 转换工具</h1>
<div class="container">

<label for="epg">EPG 地址 (TXT → M3U)：</label>
<input type="text" id="epg" value="https://epg.v1.mk/fy.xml" placeholder="输入EPG地址...">

<label for="logoBase">基础 Logo 地址：</label>
<input type="text" id="logoBase" value="https://live.404003.xyz/LOGO/" placeholder="输入基础 Logo 地址...">

<label><input type="checkbox" id="sanitizeDisplay"> 对频道名进行净化（EXTINF显示名）</label>


<textarea id="input" placeholder="在此粘贴 TXT 或 M3U 列表..."></textarea>
<div id="button-group">
<button onclick="txtToM3u()">TXT → M3U</button>
<button onclick="m3uToTxt()">M3U → TXT</button>
<button onclick="clearAll()">清空</button>
<button onclick="copyOutput()">复制结果</button>
</div>
<textarea id="output" placeholder="转换结果将在这里显示..." readonly></textarea>
</div>

<script>
// 分组规则示例 group.json
const groupRules = [
    {keywords: ['CCTV', 'cctv', '央视','cgtn','CGTN','CETV','cetv','风云','高尔夫','怀旧剧场','电视指南','世界地理','兵器科技','女性时尚','第一剧场','老故事'], group: '央视'},
    {keywords: ['卫视','凤凰'], group: '卫视'},
    {keywords: ['NewTV','newtv','NEWTV'], group: 'NewTV'},
    {keywords: ['SiTV','SITV'], group: 'SiTV'},
    {keywords: ['BesTV','百视通','bestv'], group: 'BesTV'},
    {keywords: ['咪咕','睛彩','咪视通','至臻视界'], group: '咪咕'},
    {keywords: ['CHC','动漫','卡通','少儿'], group: '数字'},
    {keywords: ['iHOT','IHOT','ihot'], group: 'iHOT'},
    {keywords: ['广播','之声','调频','FM'], group: '广播'},
{regex: /^爱.{2}/, group: 'iHOT'}, 
];

function matchGroup(channelName){
    for(let rule of groupRules){
        if(rule.regex && rule.regex.test(channelName)) return rule.group;
        if(rule.keywords){
            for(let kw of rule.keywords){
                if(channelName.includes(kw)) return rule.group;
            }
        }
    }
    return '默认';
}

// 净化函数
function sanitizeName(name){
    // CCTV 系列处理
    let cctvMatch = name.match(/^CCTV(\d+)([+K]?)/i);
    if(cctvMatch){
        let num = cctvMatch[1];
        let suffix = cctvMatch[2] || ''; // + 或 K
        // CCTV5+ 保留 +
        if(num === '5' && suffix === '+') return 'CCTV5+';
        // CCTV4K、CCTV8K 保留 K
        if((num === '4' || num === '8') && suffix.toUpperCase() === 'K') return 'CCTV'+num+'K';
        // 其他数字频道只保留数字
        return 'CCTV'+num;
    }

    let clean = name;

    // 去掉超清、高清、标清、HD、SD 及其后面的内容
    let hdIndex = clean.search(/超清|超高清|极清|高清|标清|HD|SD/i);
    if(hdIndex !== -1){
        clean = clean.substring(0, hdIndex);
    }
	
	    // 去掉短横线和下划线
    clean = clean.replace(/[-_]/g, '');

    // 去掉 () [] {} 及其中内容
    clean = clean.replace(/\[.*?\]|\(.*?\)|\{.*?\}/g, '');

    // 去掉首尾空格
    clean = clean.trim();

    return clean;
}

function txtToM3u(){
    let epg=document.getElementById('epg').value.trim();
    if(!epg) epg='https://epg.v1.mk/fy.xml';
    let logoBase=document.getElementById('logoBase').value.trim();
    if(!logoBase) logoBase='https://live.404003.xyz/LOGO/';

    let sanitizeDisplay=document.getElementById('sanitizeDisplay').checked; // 是否净化显示名

    let input=document.getElementById('input').value.trim();
    if(!input){alert("请输入 TXT 内容！");return;}

    let lines=input.split(/\r?\n/);
    let result='#EXTM3U x-tvg-url="'+epg+'"\n';
    let currentGroup='';
    for(let line of lines){
        line=line.trim();
        if(!line) continue;
        if(line.includes(',#genre#')){
            currentGroup=line.split(',')[0];
            continue;
        }
        let parts=line.split(',');
        if(parts.length<2) continue;
        let name=parts[0].trim();
        let url=parts[1].trim();
        let cleanName=sanitizeName(name); // 净化后的名称用于 tvg-id/tvg-name/logo
        let group=currentGroup || matchGroup(name);
        let logo=logoBase+cleanName+'.png';

        // 根据勾选决定显示名是否净化
        let displayName = sanitizeDisplay ? cleanName : name;

        result+='#EXTINF:-1 tvg-id="'+cleanName+'" tvg-name="'+cleanName+'" tvg-logo="'+logo+'" group-title="'+group+'",'+displayName+'\n'+url+'\n';
    }
    document.getElementById('output').value=result.trim();
}

function m3uToTxt(){
    let input=document.getElementById('input').value.trim();
    if(!input){alert("请输入 M3U 内容！");return;}
    let lines=input.split(/\r?\n/);
    let result='';
    let currentGroup='';
    for(let i=0;i<lines.length;i++){
        let line=lines[i].trim();
        if(!line) continue;
        if(line.startsWith('#EXTINF')){
            let groupMatch=line.match(/group-title="([^"]*)"/);
            let nameMatch=line.match(/tvg-name="([^"]*)"/) || line.match(/tvg-id="([^"]*)"/);
            let name=nameMatch?nameMatch[1]:'未知频道';
            let group=groupMatch?groupMatch[1]:matchGroup(name); // 没有 group 时用规则匹配
            if(group!==currentGroup){
                currentGroup=group;
                result+=currentGroup+',#genre#\n';
            }
            let url='';
            if(i+1<lines.length && !lines[i+1].startsWith('#')){
                url=lines[i+1].trim();
                i++;
            }
            result+=name+','+url+'\n';
        }
    }
    document.getElementById('output').value=result.trim();
}

function clearAll(){
    document.getElementById('input').value='';
    document.getElementById('output').value='';
}

function copyOutput(){
    let output=document.getElementById('output');
    output.select();
    output.setSelectionRange(0, 99999);
    document.execCommand('copy');
    alert('已复制到剪贴板！');
}
</script>
</body>
</html>
